# BCIndex 吸收 CodeGraph 优点的实现路径与工期拆分

> 目的：系统整理 CodeGraph 的优势点，并给出在 BCIndex 上可落地的实现路径与工期拆分。

## 1. 优点清单（来自 CodeGraph 思路）

1) **图谱 + 向量混合检索**：不仅给“相似代码”，还能给“关系上下文”。  
2) **索引分级（fast/balanced/full）**：在速度、精度和依赖之间做权衡。  
3) **LSP/编译器级解析增强**：更高精度的符号与引用解析。  
4) **文档与代码链接**：文档中的反引号符号自动关联代码。  
5) **关系/影响分析能力**：调用链、依赖链、影响面分析。  
6) **Agent 工具化**：提供“问题型工具”而非纯搜索结果。  
7) **上下文窗口自适应**：根据模型上下文调整检索量和输出预算。  
8) **上下文溢出保护**：结果截断与提示，避免工具输出失败。  
9) **解析证据与置信度**：每条关系可追溯“证据来源”。  
10) **索引可观测性与超时控制**：外部工具缺失或超时时可降级。  
11) **构建上下文与包依赖图**：理解包/模块边界与依赖关系。  
12) **架构边界规则（可选）**：违反依赖边界时标记风险。

## 2. 优点到 BCIndex 的落地映射

| 优点 | BCIndex 落地方式 | 依赖 | 推荐阶段 |
| --- | --- | --- | --- |
| 图谱 + 向量混合 | 增加 `relations` 表 + 关系补全输出 | SQLite | P1 |
| 索引分级 | 新增 `index.tier` 与降级策略 | 配置 | P1 |
| LSP 增强 | 可选接入 `gopls` 解析引用 | gopls | P3 |
| 文档链接 | Markdown 反引号符号 → `doc_links` | 解析器 | P2 |
| 影响分析 | `bcindex impact` + 关系链摘要 | 关系表 | P2/P3 |
| Agent 工具化 | MCP/CLI 增加 `context/impact/architecture/quality` | 输出层 | P2 |
| 上下文自适应 | 输出预算随模型配置调整 | 配置 | P4 |
| 溢出保护 | `max_context_chars` 与截断提示 | 输出层 | P2 |
| 证据/置信度 | 关系与命中记录 `source/confidence` | 索引 | P1 |
| 可观测性 | LSP 超时与降级、进度输出 | 运行时 | P3 |
| 构建上下文 | `go list` 包依赖与模块边界 | go list | P1 |
| 边界规则 | `boundaries` 配置与检测 | 配置 | P4 |

## 3. 实现路径（阶段化）

### P1 - 关系基础 + 索引分级（2~3 周）

交付：
- 新增 `index.tier`（fast/balanced/full）与降级策略。
- 新增 `relations` 表，落地 imports/depends_on 关系。
- 在索引结果中写入 `source/confidence/file/line` 证据字段。
- `go list` 生成包依赖（balanced 起）。

### P2 - 文档链接 + 工具化输出（2~3 周）

交付：
- Markdown 反引号符号链接到 `doc_links`。
- `mixed` 查询补全关系摘要与文档链接。
- 输出预算控制：`max_context_chars` 与截断提示。
- CLI/MCP 侧新增“问题型工具”接口（context/impact/architecture/quality）。

### P3 - gopls 增强与影响链（3~5 周）

交付：
- `full` 模式接入 gopls 解析引用/调用关系。
- `impact` 输出调用链/依赖链的最小可用版本。
- LSP 超时、缺失提示与 fail-fast/降级策略。

### P4 - 自适应与架构规则（2~4 周）

交付：
- 根据模型上下文窗口动态调整检索量与输出预算。
- 架构边界配置与违规标记（可选）。
- 质量/耦合/热点的轻量指标输出（可选）。

## 4. 工期拆分（人周估算）

| 阶段 | 工作量 | 主要模块 | 说明 |
| --- | --- | --- | --- |
| P1 | 2~3 周 | indexer/symbol_store/repo | 关系与分级是后续能力基础 |
| P2 | 2~3 周 | markdown/query/cli | 让 LLM 直接获得可用上下文 |
| P3 | 3~5 周 | lsp/impact/query | 提升精度与影响分析 |
| P4 | 2~4 周 | query/cli/config | 体验与控制项完善 |

总计：**9~15 周（1 人）**。可并行则缩短 30~40%。

## 5. 风险与缓解

- **gopls 解析不稳定**：提供超时/降级，避免阻塞索引。  
- **关系噪音**：引入置信度与来源字段，查询时可过滤。  
- **输出过长**：强制预算与截断提示，保障工具稳定性。  
- **用户配置复杂**：默认 fast + 自动降级，渐进式开启。  
